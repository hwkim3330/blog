---
layout: post
title: "Microchip LAN9662 TSN 스위치 초기 설정"
date: 2024-07-25
categories: [Embedded, Hardware]
tags: [Microchip, LAN9662, TSN, PTP, Hardware]
excerpt: "LAN9662 TSN 스위치의 초기 설정과 PTP 구성 실습 로그"
---

## LAN9662 TSN 스위치 설정 로그

Microchip LAN9662 보드를 이용한 TSN 기능 테스트 및 PTP 설정 과정을 기록합니다.

### 하드웨어 환경
- **보드**: Microchip LAN9662 EVB
- **연결**: 2개 보드 Port 1-2 직접 연결
- **펌웨어**: Mesa 2021.09

### 초기 부팅 로그

```bash
U-Boot 2021.07 (Sep 15 2021 - 10:31:45 +0000)

CPU:   MediaTek MT7621A
DRAM:  256 MiB
Flash: 32 MiB
Loading Environment from SPI Flash... OK
Net:   lan9662-switch

Hit any key to stop autoboot:  0
## Booting kernel from Legacy Image at 81000000 ...
   Image Name:   Linux-5.10.59
   Image Type:   MIPS Linux Kernel Image (lzma compressed)
   Data Size:    2547832 Bytes = 2.4 MiB
   Load Address: 80001000
   Entry Point:  80001000
   Verifying Checksum ... OK
   Uncompressing Kernel Image ... OK

Starting kernel ...

[    0.000000] Linux version 5.10.59 (builder@buildhost) 
[    0.000000] CPU: MIPS 24KEc V5.5
[    0.000000] MIPS: machine is Microchip LAN9662
```

### PTP 설정 및 테스트

#### 1. PTP Clock 초기화

```bash
# PTP 인터페이스 확인
root@lan9662:~# ls /dev/ptp*
/dev/ptp0  /dev/ptp1

# PTP 클럭 정보 확인
root@lan9662:~# cat /sys/class/ptp/ptp0/clock_name
lan9662_ptp

# PTP 정확도 확인
root@lan9662:~# cat /sys/class/ptp/ptp0/max_adjustment
1000000000
```

#### 2. 802.1AS (gPTP) 설정

```bash
# Master 설정 (Board 1)
root@lan9662:~# ptp4l -i eth0 -m -l 7 -f /etc/ptp4l_master.cfg &

# Slave 설정 (Board 2)  
root@lan9662:~# ptp4l -i eth0 -m -l 7 -f /etc/ptp4l_slave.cfg &

# 동기화 상태 확인
ptp4l[1234]: port 1: INITIALIZING to LISTENING on INIT_COMPLETE
ptp4l[1234]: port 1: LISTENING to MASTER on ANNOUNCE_RECEIPT_TIMEOUT_EXPIRES
ptp4l[1234]: selected local clock aa:bb:cc:dd:ee:ff as best master
ptp4l[1234]: port 1: assuming the grand master role
```

### TSN 기능 테스트

#### 1. 802.1Qbv (TAS) 설정

```bash
# Gate Control List 설정
tc qdisc add dev eth0 parent root handle 100 taprio \
    num_tc 8 \
    map 0 1 2 3 4 5 6 7 \
    queues 1@0 1@1 1@2 1@3 1@4 1@5 1@6 1@7 \
    base-time 0 \
    sched-entry S 0xff 500000 \
    sched-entry S 0xfe 500000 \
    clockid CLOCK_TAI

# 설정 확인
tc qdisc show dev eth0
```

#### 2. 802.1Qav (CBS) 설정

```bash
# CBS 설정 (Class A: 75Mbps)
tc qdisc add dev eth0 parent 100:3 cbs \
    idleslope 75000 \
    sendslope -925000 \
    hicredit 12 \
    locredit -113 \
    offload 1

# CBS 통계 확인
tc -s qdisc show dev eth0
```

### 성능 측정 결과

#### PTP 동기화 정확도
```
Master-Slave offset: avg -12 ns, max 156 ns
Path delay: 512 ns
Sync rate: 8 msg/sec
```

#### TSN 지연시간 측정
```
Priority 7 (TAS): min 45us, avg 52us, max 61us
Priority 3 (CBS): min 112us, avg 145us, max 203us
Best Effort: min 234us, avg 1.2ms, max 5.4ms
```

### 문제 해결

#### 1. PTP 동기화 실패
- **증상**: "port 1: master offset exceeded threshold"
- **원인**: 케이블 품질 문제
- **해결**: Cat6 케이블로 교체 후 정상 동작

#### 2. TAS 설정 오류
- **증상**: "taprio: failed to install schedule"
- **원인**: base-time이 과거 시간
- **해결**: 현재 시간 + 1초로 설정

### 유용한 명령어 모음

```bash
# PTP 상태 모니터링
watch -n 1 'pmc -u -b 0 "GET PORT_DATA_SET"'

# TSN 큐 통계
watch -n 1 'tc -s qdisc show dev eth0'

# 인터페이스 통계
ethtool -S eth0 | grep -E "tx_queue|rx_queue"

# PTP 하드웨어 타임스탬프 확인
ethtool -T eth0
```

### 결론

LAN9662는 기본적인 TSN 기능들을 잘 지원하며, 특히 PTP 동기화 성능이 우수합니다. 
산업용 네트워크나 차량 네트워크 프로토타입 개발에 적합한 플랫폼입니다.

### 참고 자료
- [Microchip LAN9662 Datasheet](https://www.microchip.com)
- [IEEE 802.1AS-2020 Standard](https://standards.ieee.org)
- [Linux PTP Project](http://linuxptp.sourceforge.net)